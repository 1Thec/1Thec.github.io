<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria de Trabalhos dos Alunos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Galeria de Trabalhos dos Alunos</h1>
        <p>Carregue e compartilhe suas criações!</p>
    </header>

    <div class="container">
        <h2>Carregar Novo Trabalho</h2>
        <form id="uploadForm">
            <label for="imageUpload">Escolha um arquivo de imagem:</label><br>
            <input type="file" id="imageUpload" accept="image/*"><br><br>
            <label for="description">Descrição do trabalho:</label><br>
            <textarea id="description" rows="3" placeholder="Escreva uma descrição para o trabalho..."></textarea><br>
            <button type="button" onclick="uploadWork()">Enviar Trabalho</button>
        </form>
    </div>

    <div class="container gallery" id="gallery">
        <!-- Trabalhos carregados serão exibidos aqui -->
    </div>

    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    
    <script>
        // Configuração do Firebase (substitua com as informações do seu projeto)
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Inicialize o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // Autenticação anônima para permitir o upload de trabalhos
        auth.signInAnonymously().catch((error) => {
            console.error("Erro ao autenticar: ", error);
        });

        // Função para carregar o trabalho
        async function uploadWork() {
            const fileInput = document.querySelector('#imageUpload');
            const description = document.querySelector('#description').value;
            const file = fileInput.files[0];

            if (!file || !description) {
                alert("Por favor, selecione uma imagem e insira uma descrição.");
                return;
            }

            // Envia a imagem para o Firebase Storage
            const storageRef = storage.ref('imagens/' + file.name);
            await storageRef.put(file);
            const imageUrl = await storageRef.getDownloadURL();

            // Salva a URL da imagem e descrição no Firestore
            await db.collection("trabalhos").add({
                imageUrl: imageUrl,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Limpa o formulário e exibe a nova galeria
            fileInput.value = '';
            document.querySelector('#description').value = '';
            displayGallery();
        }

        // Função para exibir a galeria com rolagem infinita
        async function displayGallery(lastVisibleDoc = null) {
            const gallery = document.getElementById('gallery');

            // Define o número de trabalhos a carregar por vez
            const limit = 5;

            // Cria uma consulta para carregar trabalhos
            let query = db.collection("trabalhos")
                .orderBy("timestamp", "desc")
                .limit(limit);

            if (lastVisibleDoc) {
                query = query.startAfter(lastVisibleDoc);
            }

            const snapshot = await query.get();
            const docs = snapshot.docs;
            const lastDoc = docs[docs.length - 1];

            docs.forEach(doc => {
                const data = doc.data();

                const galleryItem = document.createElement('div');
                galleryItem.classList.add('gallery-item');

                const img = document.createElement('img');
                img.src = data.imageUrl;
                img.alt = "Imagem do trabalho";

                const desc = document.createElement('p');
                desc.classList.add('description');
                desc.textContent = data.description;

                galleryItem.appendChild(img);
                galleryItem.appendChild(desc);
                gallery.appendChild(galleryItem);
            });

            // Carrega mais itens ao rolar para baixo
            window.onscroll = () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
                    displayGallery(lastDoc);
                }
            };
        }

        // Carrega a galeria ao iniciar
        displayGallery();
    </script>
</body>
</html>
